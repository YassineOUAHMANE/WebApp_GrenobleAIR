<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seamless Zoomable Map Tiles</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-tile@1.0.0/dist/d3-tile.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        #header {
            color: grey;
            font: 13px/25.5px sans-serif;
            text-transform: uppercase;
            padding: 10px;
            background-color: #f8f8f8;
        }
        #header a {
            color: grey;
            text-decoration: none;
        }
        #map-container {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div id="header">
        <a href="https://d3js.org/">D3</a> â€º Map
        <h1>Seamless Zoomable Map Tiles</h1>
    </div>
    <div id="map-container"></div>

    <script>
        // Configuration
        const width = 800;
        const height = 600;
        const deltas = [0];
        // const deltas = [-100, -4, -1, 0];
        // const url = (x, y, z) => `https://tile.opentopomap.org/${z}/${x}/${y}.png`;
        const url = (x, y, z) => `https://tile.openstreetmap.org/${z}/${x}/${y}.png`;

        // Create the SVG container
        const svg = d3.select("#map-container")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("viewBox", [0, 0, width, height]);

        // Create the tile generator
        const tile = d3.tile()
            .extent([[0, 0], [width, height]])
            .tileSize(256)
            .clampX(false);

        // Create the zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([1 << 8, 1 << 22])
            .extent([[0, 0], [width, height]])
            .on("zoom", (event) => zoomed(event.transform));

        // Initial transform
        let transform = d3.zoomIdentity
            .translate(width >> 1, height >> 1)
            .scale(1 << 12);

        // Create groups for each delta level
        const levels = svg.append("g")
            .attr("pointer-events", "none")
            .selectAll("g")
            .data(deltas)
            .join("g")
            // .style("opacity", 1);

        // Apply zoom behavior to the SVG
        svg.call(zoom)
            .call(zoom.transform, transform);

        // Function to handle zoom events
        function zoomed(t) {
            transform = t;
            levels.each(function(delta) {
                const tiles = tile.zoomDelta(delta)(transform);
                d3.select(this)
                    .selectAll("image")
                    .data(tiles, d => d)
                    .join("image")
                        .attr("xlink:href", d => url(...d3.tileWrap(d)))
                        .attr("x", ([x]) => (x + tiles.translate[0]) * tiles.scale)
                        .attr("y", ([, y]) => (y + tiles.translate[1]) * tiles.scale)
                        .attr("width", tiles.scale)
                        .attr("height", tiles.scale);
            });
        }
    </script>
</body>
</html>
